---
title: Descriptive Statistics
---

```{r}
source("notebooks/initialize-data-analysis.r")
```

```{r}
library(gtsummary)

table_stats <- data_patient_complete |>
  select(
    all_of(predictor_list), starts_with("comed"), flag_ADR_TP_ID
  ) |>
  tbl_summary(
    by = flag_ADR_TP_ID,
    statistic = list(all_continuous() ~ "{median} ({p25} - {p75})"),
    missing = "no"
  ) |>
  # modify_table_body(
  #   ~ .x |>
  #     mutate(stat_1 = if_else(str_detect(stat_1, "NA"), NA, stat_1))
  # ) |>
  add_overall() |>
  bold_labels()
```

```{r}
library(tidymodels)
library(furrr)

data_patient_complete_response_as_factor <- data_patient_complete |>
  mutate(
    flag_ADR_TP_ID = as.factor(flag_ADR_TP_ID)
  )

fit_univariate_regression <- function(predictor) {
  model <- logistic_reg() |>
    set_engine("glm") |>
    set_mode("classification") |>
    fit(
      reformulate(
        termlabels = predictor,
        response = "flag_ADR_TP_ID"
      ),
      data = data_patient_complete_response_as_factor
    )
}

arrange_univariate_regression <- function(model) {
  model |>
    tbl_regression(
      exponentiate = TRUE,
      show_single_row = everything()
    ) |>
    bold_p()
}

plan(multisession, workers = min(parallel::detectCores() - 2, 10))
uni_model_list <- future_map(predictor_list, fit_univariate_regression)
table_uni_list <- future_map(uni_model_list, arrange_univariate_regression)
plan(sequential)

table_uni <- tbl_stack(table_uni_list)
```

```{r}
table_descriptive <- tbl_merge(
  list(table_stats, table_uni),
  tab_spanner = c(
    "**Thrombocytopenia Status**",
    "**Univariate Regression**"
  )
)
save(table_descriptive, file = "data/results/table-descriptive.rda")
```

```{r}
table_descriptive_site <- data_patient_complete |>
  select(
    all_of(predictor_list), starts_with("comed"), flag_ADR_TP_ID, site
  ) |>
  tbl_summary(
    by = site,
    statistic = list(all_continuous() ~ "{median} ({p25} - {p75})"),
    missing = "no"
  ) |>
  add_overall() |>
  bold_labels()

save(table_descriptive_site, file = "data/results/table-descriptive-site.rda")
```