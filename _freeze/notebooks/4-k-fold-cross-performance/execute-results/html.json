{
  "hash": "ae469045f9c70dc6a7522c0e53db162a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 10-fold Development and Cross-Validation\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsource(\"notebooks/initialize-data-analysis.r\", local = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.4.4     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.0\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\nRows: 5669 Columns: 113\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr   (4): patient_ID, site, dept, LZD_route\ndbl  (20): patient_age, patient_weight, charlson, baseline_CLCR, baseline_WB...\nlgl  (85): patient_sex, dept_ICU, dept_ER, dept_other, invasive_ETI, invasiv...\ndate  (4): baseline_date, LZD_start, LZD_end, test_date\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\nRows: 780 Columns: 105\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr   (4): patient_ID, site, dept, LZD_route\ndbl  (13): patient_age, patient_weight, charlson, baseline_CLCR, baseline_WB...\nlgl  (85): patient_sex, dept_ICU, dept_ER, dept_other, invasive_ETI, invasiv...\ndate  (3): baseline_date, LZD_start, LZD_end\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(BAS)\nlibrary(rsample) # for vfold_cv()\nlibrary(furrr) # for future_map()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: future\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching packages ────────────────────────────────────── tidymodels 1.1.1 ──\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n✔ broom        1.0.5     ✔ recipes      1.0.9\n✔ dials        1.2.0     ✔ tune         1.1.2\n✔ infer        1.0.5     ✔ workflows    1.1.3\n✔ modeldata    1.3.0     ✔ workflowsets 1.0.1\n✔ parsnip      1.1.1     ✔ yardstick    1.3.0\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ scales::discard() masks purrr::discard()\n✖ dplyr::filter()   masks stats::filter()\n✖ recipes::fixed()  masks stringr::fixed()\n✖ dplyr::lag()      masks stats::lag()\n✖ yardstick::spec() masks readr::spec()\n✖ recipes::step()   masks stats::step()\n• Dig deeper into tidy modeling with R at https://www.tmwr.org\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(CalibrationCurves)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: rms\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: Hmisc\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'Hmisc'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:parsnip':\n\n    translate\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:dplyr':\n\n    src, summarize\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:base':\n\n    format.pval, units\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ndata_patient_fold_prep <- data_patient_complete |>\n  select(all_of(predictor_list), flag_ADR_TP_ID)\n\nfold_samples <- vfold_cv(data_patient_fold_prep, v = 10, repeats = 3)\n\nrun_bas_glm <- function(data, formula, family, ...) {\n  bas.glm(formula, data = data, family = family, ...)\n}\n\nextract_variable_names <- function(sample) {\n  data <- analysis(sample)\n  model <- data |>\n    run_bas_glm(\n      formula = flag_ADR_TP_ID ~ .,\n      family = binomial(),\n      MCMC.iterations = 100000,\n      method = \"MCMC\"\n    )\n  variable.names(predict(model, estimator = \"HPM\"))[-1] |>\n    str_extract(paste(predictor_list, collapse = \"|\"))\n}\n\n# Function to modify sample data and fit model\nfit_model_to_sample <- function(sample, variables) {\n  data <- analysis(sample) |>\n    mutate(flag_ADR_TP_ID = as.factor(flag_ADR_TP_ID))\n\n  formula <- reformulate(termlabels = variables, response = \"flag_ADR_TP_ID\")\n\n  logistic_reg() |>\n    set_engine(\"glm\") |>\n    set_mode(\"classification\") |>\n    fit(formula, data = data)\n}\n\ncalc_fold_performance <- function(sample, model) {\n  data <- assessment(sample)\n  pHat <- predict(model$fit, data, type = \"response\")\n  yTest <- data$flag_ADR_TP_ID\n  calperf <- valProbggplot(pHat, yTest, smooth = \"none\")\n\n  tibble(\n    fold_C_index = calperf$Cindex[[1]],\n    fold_calibration_intercept = calperf$Calibration$Intercept[[1]],\n    fold_calibration_slope = calperf$Calibration$Slope[[1]]\n  )\n}\n\n# Set up future to use multiple cores\nplan(multisession, workers = min(parallel::detectCores() - 2, 10))\n\nfold_predict_HPM <- fold_samples$splits |>\n  future_map(extract_variable_names, .options = furrr_options(seed = TRUE))\n\n# Fit model to each sample in parallel\nfold_full <- future_map2(fold_samples$splits, fold_predict_HPM, fit_model_to_sample)\n\nfold_estimates <- future_map2_dfr(fold_samples$splits, fold_full, calc_fold_performance)\n\nplan(sequential)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfold_performance_metrics <- fold_estimates |>\n  summarise(\n    mean_fold_C_index = mean(fold_C_index),\n    mean_fold_calibration_intercept = mean(fold_calibration_intercept),\n    mean_fold_calibration_slope = mean(fold_calibration_slope)\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsave(fold_performance_metrics, file = \"data/model-performance/fold-performance-metrics.rda\")\n```\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}