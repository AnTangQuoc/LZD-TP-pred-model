{
  "hash": "c6b68de15ddbb7aae32ca5d467a77cda",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Model Development and Apparent Validation\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsource(\"notebooks/initialize-data-analysis.r\", local = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.4.4     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.0\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\nRows: 5669 Columns: 113\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr   (4): patient_ID, site, dept, LZD_route\ndbl  (20): patient_age, patient_weight, charlson, baseline_CLCR, baseline_WB...\nlgl  (85): patient_sex, dept_ICU, dept_ER, dept_other, invasive_ETI, invasiv...\ndate  (4): baseline_date, LZD_start, LZD_end, test_date\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\nRows: 780 Columns: 105\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr   (4): patient_ID, site, dept, LZD_route\ndbl  (13): patient_age, patient_weight, charlson, baseline_CLCR, baseline_WB...\nlgl  (85): patient_sex, dept_ICU, dept_ER, dept_other, invasive_ETI, invasiv...\ndate  (3): baseline_date, LZD_start, LZD_end\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(BAS)\nrun_bas_glm <- function(data, formula, family, ...) {\n  bas.glm(formula, data = data, family = family, ...)\n}\n\nmulti_model <- data_patient_complete |>\n  select(all_of(predictor_list), flag_ADR_TP_ID) |>\n  run_bas_glm(\n    formula = flag_ADR_TP_ID ~ .,\n    family = binomial(),\n    MCMC.iterations = 100000,\n    method = \"MCMC\"\n  )\n\nsummary(multi_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                         P(B != 0 | Y)       model 1   model 2      model 3\nIntercept                      1.00000    1.00000000    1.0000    1.0000000\npatient_age                    0.74629    1.00000000    1.0000    1.0000000\npatient_sexTRUE                0.01255    0.00000000    0.0000    0.0000000\nLZD_dose_per_weight            0.01498    0.00000000    0.0000    0.0000000\nbaseline_CLCR                  0.32591    0.00000000    0.0000    0.0000000\ndept_ERTRUE                    0.01479    0.00000000    0.0000    0.0000000\ndept_ICUTRUE                   0.03158    0.00000000    0.0000    0.0000000\nbaseline_HGB                   0.16606    0.00000000    0.0000    0.0000000\nbaseline_WBC                   0.02029    0.00000000    0.0000    0.0000000\nbaseline_PLT                   0.99998    1.00000000    1.0000    1.0000000\nLZD_duration                   0.99668    1.00000000    1.0000    1.0000000\ninvasive_ETITRUE               0.24101    0.00000000    0.0000    0.0000000\ninvasive_CVCTRUE               0.41229    0.00000000    1.0000    0.0000000\ninvasive_IHDTRUE               0.01909    0.00000000    0.0000    0.0000000\ninvasive_CRRTTRUE              0.96557    1.00000000    1.0000    1.0000000\ncomorb_HTNTRUE                 0.01410    0.00000000    0.0000    0.0000000\ncomorb_DMTRUE                  0.01577    0.00000000    0.0000    0.0000000\ncomorb_HFTRUE                  0.07423    0.00000000    0.0000    0.0000000\ncomorb_anginaTRUE              0.01350    0.00000000    0.0000    0.0000000\ncomorb_cirrTRUE                0.10595    0.00000000    0.0000    0.0000000\ncomorb_COPDTRUE                0.02749    0.00000000    0.0000    0.0000000\ncomorb_CVATRUE                 0.07318    0.00000000    0.0000    0.0000000\ncomorb_MITRUE                  0.02502    0.00000000    0.0000    0.0000000\ncomorb_KTRUE                   0.01535    0.00000000    0.0000    0.0000000\ncomorb_hematologicalTRUE       0.02938    0.00000000    0.0000    0.0000000\ncomorb_hemaTRUE                0.01474    0.00000000    0.0000    0.0000000\ninfect_sepsisTRUE              0.07360    0.00000000    0.0000    0.0000000\ninfect_CAPTRUE                 0.01898    0.00000000    0.0000    0.0000000\ninfect_HAPTRUE                 0.03223    0.00000000    0.0000    0.0000000\ninfect_SSTITRUE                0.03778    0.00000000    0.0000    0.0000000\ninfect_CNSTRUE                 0.01708    0.00000000    0.0000    0.0000000\ninfect_IAITRUE                 0.01102    0.00000000    0.0000    0.0000000\ninfect_UTITRUE                 0.01227    0.00000000    0.0000    0.0000000\ninfect_BJITRUE                 0.01756    0.00000000    0.0000    0.0000000\ninfect_septicemiaTRUE          0.18028    0.00000000    0.0000    0.0000000\ncomed_aspirinTRUE              0.01946    0.00000000    0.0000    0.0000000\ncomed_diclofenacTRUE           0.01803    0.00000000    0.0000    0.0000000\ncomed_ibuprofenTRUE            0.01509    0.00000000    0.0000    0.0000000\ncomed_paracetamolTRUE          0.01648    0.00000000    0.0000    0.0000000\ncomed_penicillinTRUE           0.02153    0.00000000    0.0000    0.0000000\ncomed_cephaTRUE                0.02620    0.00000000    0.0000    0.0000000\ncomed_carbapenemTRUE           0.02409    0.00000000    0.0000    0.0000000\ncomed_cotrimoxazolTRUE         0.08442    0.00000000    0.0000    0.0000000\ncomed_vancomycinTRUE           0.04370    0.00000000    0.0000    0.0000000\ncomed_levofloxacinTRUE         0.01126    0.00000000    0.0000    0.0000000\ncomed_teicoplaninTRUE          0.20629    0.00000000    0.0000    0.0000000\ncomed_ethambutolTRUE           0.01695    0.00000000    0.0000    0.0000000\ncomed_pyrazinamidTRUE          0.02457    0.00000000    0.0000    0.0000000\ncomed_rifampinTRUE             0.01800    0.00000000    0.0000    0.0000000\ncomed_heparinTRUE              0.15723    0.00000000    0.0000    0.0000000\ncomed_clopidogrelTRUE          0.03129    0.00000000    0.0000    0.0000000\ncomed_enoxaparinTRUE           0.01640    0.00000000    0.0000    0.0000000\ncomed_dexamethasonTRUE         0.01447    0.00000000    0.0000    0.0000000\ncomed_amiodaronTRUE            0.06449    0.00000000    0.0000    0.0000000\ncomed_furosemidTRUE            0.15198    0.00000000    0.0000    1.0000000\ncomed_haloperidolTRUE          0.01313    0.00000000    0.0000    0.0000000\ncomed_valproicTRUE             0.01037    0.00000000    0.0000    0.0000000\nBF                                  NA    0.09987475    1.0000    0.2923257\nPostProbs                           NA    0.05450000    0.0480    0.0202000\nR2                                  NA    0.17030000    0.1804    0.1780000\ndim                                 NA    5.00000000    6.0000    6.0000000\nlogmarg                             NA -426.88412099 -424.5803 -425.8101691\n                              model 4       model 5\nIntercept                   1.0000000    1.00000000\npatient_age                 0.0000000    0.00000000\npatient_sexTRUE             0.0000000    0.00000000\nLZD_dose_per_weight         0.0000000    0.00000000\nbaseline_CLCR               1.0000000    1.00000000\ndept_ERTRUE                 0.0000000    0.00000000\ndept_ICUTRUE                0.0000000    0.00000000\nbaseline_HGB                0.0000000    0.00000000\nbaseline_WBC                0.0000000    0.00000000\nbaseline_PLT                1.0000000    1.00000000\nLZD_duration                1.0000000    1.00000000\ninvasive_ETITRUE            1.0000000    0.00000000\ninvasive_CVCTRUE            0.0000000    0.00000000\ninvasive_IHDTRUE            0.0000000    0.00000000\ninvasive_CRRTTRUE           1.0000000    1.00000000\ncomorb_HTNTRUE              0.0000000    0.00000000\ncomorb_DMTRUE               0.0000000    0.00000000\ncomorb_HFTRUE               0.0000000    0.00000000\ncomorb_anginaTRUE           0.0000000    0.00000000\ncomorb_cirrTRUE             0.0000000    0.00000000\ncomorb_COPDTRUE             0.0000000    0.00000000\ncomorb_CVATRUE              0.0000000    0.00000000\ncomorb_MITRUE               0.0000000    0.00000000\ncomorb_KTRUE                0.0000000    0.00000000\ncomorb_hematologicalTRUE    0.0000000    0.00000000\ncomorb_hemaTRUE             0.0000000    0.00000000\ninfect_sepsisTRUE           0.0000000    0.00000000\ninfect_CAPTRUE              0.0000000    0.00000000\ninfect_HAPTRUE              0.0000000    0.00000000\ninfect_SSTITRUE             0.0000000    0.00000000\ninfect_CNSTRUE              0.0000000    0.00000000\ninfect_IAITRUE              0.0000000    0.00000000\ninfect_UTITRUE              0.0000000    0.00000000\ninfect_BJITRUE              0.0000000    0.00000000\ninfect_septicemiaTRUE       0.0000000    0.00000000\ncomed_aspirinTRUE           0.0000000    0.00000000\ncomed_diclofenacTRUE        0.0000000    0.00000000\ncomed_ibuprofenTRUE         0.0000000    0.00000000\ncomed_paracetamolTRUE       0.0000000    0.00000000\ncomed_penicillinTRUE        0.0000000    0.00000000\ncomed_cephaTRUE             0.0000000    0.00000000\ncomed_carbapenemTRUE        0.0000000    0.00000000\ncomed_cotrimoxazolTRUE      0.0000000    0.00000000\ncomed_vancomycinTRUE        0.0000000    0.00000000\ncomed_levofloxacinTRUE      0.0000000    0.00000000\ncomed_teicoplaninTRUE       0.0000000    0.00000000\ncomed_ethambutolTRUE        0.0000000    0.00000000\ncomed_pyrazinamidTRUE       0.0000000    0.00000000\ncomed_rifampinTRUE          0.0000000    0.00000000\ncomed_heparinTRUE           0.0000000    0.00000000\ncomed_clopidogrelTRUE       0.0000000    0.00000000\ncomed_enoxaparinTRUE        0.0000000    0.00000000\ncomed_dexamethasonTRUE      0.0000000    0.00000000\ncomed_amiodaronTRUE         0.0000000    0.00000000\ncomed_furosemidTRUE         0.0000000    0.00000000\ncomed_haloperidolTRUE       0.0000000    0.00000000\ncomed_valproicTRUE          0.0000000    0.00000000\nBF                          0.2919302    0.03355848\nPostProbs                   0.0135000    0.01260000\nR2                          0.1780000    0.16810000\ndim                         6.0000000    5.00000000\nlogmarg                  -425.8115233 -427.97474816\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nplot(multi_model)\n```\n\n::: {.cell-output-display}\n![](apparent-performance_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](apparent-performance_files/figure-html/unnamed-chunk-2-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](apparent-performance_files/figure-html/unnamed-chunk-2-3.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](apparent-performance_files/figure-html/unnamed-chunk-2-4.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\nimage(multi_model, rotate = FALSE)\n```\n\n::: {.cell-output-display}\n![](apparent-performance_files/figure-html/unnamed-chunk-2-5.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\ndiagnostics(multi_model)\n```\n\n::: {.cell-output-display}\n![](apparent-performance_files/figure-html/unnamed-chunk-2-6.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](apparent-performance_files/figure-html/unnamed-chunk-2-7.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\nmulti_predict_HPM <- variable.names(predict(multi_model, estimator = \"HPM\"))[-1] |>\n  str_extract(paste(predictor_list, collapse = \"|\"))\nmulti_predict_BPM <- variable.names(predict(multi_model, estimator = \"BPM\"))[-1] |>\n  str_extract(paste(predictor_list, collapse = \"|\")) # this model is weird\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching packages ────────────────────────────────────── tidymodels 1.1.1 ──\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n✔ broom        1.0.5     ✔ rsample      1.2.0\n✔ dials        1.2.0     ✔ tune         1.1.2\n✔ infer        1.0.5     ✔ workflows    1.1.3\n✔ modeldata    1.3.0     ✔ workflowsets 1.0.1\n✔ parsnip      1.1.1     ✔ yardstick    1.3.0\n✔ recipes      1.0.9     \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ scales::discard() masks purrr::discard()\n✖ dplyr::filter()   masks stats::filter()\n✖ recipes::fixed()  masks stringr::fixed()\n✖ dplyr::lag()      masks stats::lag()\n✖ yardstick::spec() masks readr::spec()\n✖ recipes::step()   masks stats::step()\n• Dig deeper into tidy modeling with R at https://www.tmwr.org\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ndata_patient_complete_response_as_factor <- data_patient_complete |>\n  mutate(\n    flag_ADR_TP_ID = as.factor(flag_ADR_TP_ID)\n  )\n\nmodel_full <- logistic_reg() |>\n  set_engine(\"glm\") |>\n  set_mode(\"classification\") |>\n  fit(\n    reformulate(\n      termlabels = multi_predict_HPM,\n      response = \"flag_ADR_TP_ID\"\n    ),\n    data = data_patient_complete_response_as_factor\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(CalibrationCurves)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: rms\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: Hmisc\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'Hmisc'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:parsnip':\n\n    translate\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:dplyr':\n\n    src, summarize\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:base':\n\n    format.pval, units\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\npHat <- predict(model_full$fit, data_patient_complete, type = \"response\")\nyTest <- data_patient_complete$flag_ADR_TP_ID\ncalperf <- valProbggplot(pHat, yTest)\ncalperf$Cindex[[1]]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.7779549\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ncalperf$Calibration$Intercept[[1]]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] -8.405144e-10\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ncalperf$Calibration$Slope[[1]]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsave(model_full, file = \"data/model-performance/model_full.rda\")\n```\n:::",
    "supporting": [
      "apparent-performance_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}