{
  "hash": "05e3b37101c6b63384e302a5805eb181",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Internal-External Development and Cross-Validation\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsource(\"notebooks/initialize-data-analysis.r\", local = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.4.4     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.0\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\nRows: 5669 Columns: 113\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr   (4): patient_ID, site, dept, LZD_route\ndbl  (20): patient_age, patient_weight, charlson, baseline_CLCR, baseline_WB...\nlgl  (85): patient_sex, dept_ICU, dept_ER, dept_other, invasive_ETI, invasiv...\ndate  (4): baseline_date, LZD_start, LZD_end, test_date\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\nRows: 780 Columns: 105\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr   (4): patient_ID, site, dept, LZD_route\ndbl  (13): patient_age, patient_weight, charlson, baseline_CLCR, baseline_WB...\nlgl  (85): patient_sex, dept_ICU, dept_ER, dept_other, invasive_ETI, invasiv...\ndate  (3): baseline_date, LZD_start, LZD_end\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(BAS)\nlibrary(rsample) # for group_vfold_cv()\nlibrary(furrr) # for future_map()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: future\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching packages ────────────────────────────────────── tidymodels 1.1.1 ──\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n✔ broom        1.0.5     ✔ recipes      1.0.9\n✔ dials        1.2.0     ✔ tune         1.1.2\n✔ infer        1.0.5     ✔ workflows    1.1.3\n✔ modeldata    1.3.0     ✔ workflowsets 1.0.1\n✔ parsnip      1.1.1     ✔ yardstick    1.3.0\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ scales::discard() masks purrr::discard()\n✖ dplyr::filter()   masks stats::filter()\n✖ recipes::fixed()  masks stringr::fixed()\n✖ dplyr::lag()      masks stats::lag()\n✖ yardstick::spec() masks readr::spec()\n✖ recipes::step()   masks stats::step()\n• Search for functions across packages at https://www.tidymodels.org/find/\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(CalibrationCurves)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: rms\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: Hmisc\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'Hmisc'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:parsnip':\n\n    translate\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:dplyr':\n\n    src, summarize\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:base':\n\n    format.pval, units\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ndata_patient_cross_prep <- data_patient_complete |>\n  select(all_of(predictor_list), flag_ADR_TP_ID, site)\n\ncross_samples <- group_vfold_cv(data_patient_cross_prep, group = \"site\")\n\nrun_bas_glm <- function(data, formula, family, ...) {\n  bas.glm(formula, data = data, family = family, ...)\n}\n\nextract_variable_names_cross <- function(sample) {\n  data <- analysis(sample) |> select(-site)\n  model <- data |>\n    run_bas_glm(\n      formula = flag_ADR_TP_ID ~ .,\n      family = binomial(),\n      MCMC.iterations = 100000,\n      method = \"MCMC\"\n    )\n  variable.names(predict(model, estimator = \"HPM\"))[-1] |>\n    str_extract(paste(predictor_list, collapse = \"|\"))\n}\n\n# Function to modify sample data and fit model\nfit_model_to_sample <- function(sample, variables) {\n  data <- analysis(sample) |>\n    mutate(flag_ADR_TP_ID = as.factor(flag_ADR_TP_ID))\n\n  formula <- reformulate(termlabels = variables, response = \"flag_ADR_TP_ID\")\n\n  logistic_reg() |>\n    set_engine(\"glm\") |>\n    set_mode(\"classification\") |>\n    fit(formula, data = data)\n}\n\ncalc_cross_performance <- function(sample, model) {\n  data <- assessment(sample)\n  pHat <- predict(model$fit, data, type = \"response\")\n  yTest <- data$flag_ADR_TP_ID\n  calperf <- valProbggplot(pHat, yTest, smooth = \"none\")\n\n  tibble(\n    site = data$site[1],\n    n = nrow(data),\n    cross_C_index = calperf$Cindex[[1]],\n    cross_C_index_lower = calperf$Cindex[[2]],\n    cross_C_index_upper = calperf$Cindex[[3]],\n    cross_calibration_intercept = calperf$Calibration$Intercept[[1]],\n    cross_calibration_intercept_lower = calperf$Calibration$Intercept[[2]],\n    cross_calibration_intercept_upper = calperf$Calibration$Intercept[[3]],\n    cross_calibration_slope = calperf$Calibration$Slope[[1]],\n    cross_calibration_slope_lower = calperf$Calibration$Slope[[2]],\n    cross_calibration_slope_upper = calperf$Calibration$Slope[[3]]\n  )\n}\n\n# Set up future to use multiple cores\nplan(multisession, workers = 6)\n\ncross_predict_HPM <- cross_samples$splits |>\n  future_map(extract_variable_names_cross, .options = furrr_options(seed = TRUE))\n\n# Fit model to each sample in parallel\ncross_full <- future_map2(cross_samples$splits, cross_predict_HPM, fit_model_to_sample)\n\ncross_estimates <- future_map2_dfr(cross_samples$splits, cross_full, calc_cross_performance)\n\nplan(sequential)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(meta)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: metadat\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading 'meta' package (version 7.0-0).\nType 'help(meta)' for a brief overview.\nReaders of 'Meta-Analysis with R (Use R!)' should install\nolder version of 'meta' package: https://tinyurl.com/dt4y5drs\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ncross_C_index_meta <- metagen(\n  data = cross_estimates,\n  studlab = site,\n  TE = cross_C_index,\n  lower = cross_C_index_lower,\n  upper = cross_C_index_upper,\n  sm = \"C_statistic\",\n  common = FALSE,\n  random = TRUE,\n  method.tau = \"REML\",\n  method.random.ci = \"HK\",\n  adhoc.hakn.ci = \"IQWiG6\",\n)\n\nforest_plot_C_index <- forest(\n  cross_C_index_meta,\n  sortvar = TE,\n  ref = NA,\n  xlim = c(0.6, 0.9),\n  layout = \"RevMan5\"\n)\n```\n\n::: {.cell-output-display}\n![](4-internal-external-cross-performance_files/figure-jats/unnamed-chunk-3-1.png)\n:::\n\n```{.r .cell-code .hidden}\ncross_calibration_intercept_meta <- metagen(\n  data = cross_estimates,\n  studlab = site,\n  TE = cross_calibration_intercept,\n  lower = cross_calibration_intercept_lower,\n  upper = cross_calibration_intercept_upper,\n  sm = \"C_intercept\",\n  common = FALSE,\n  random = TRUE,\n  method.tau = \"REML\",\n  method.random.ci = \"HK\",\n  adhoc.hakn.ci = \"IQWiG6\",\n  null.effect = 0\n)\n\nforest_plot_calibration_intercept <- forest(\n  cross_calibration_intercept_meta,\n  sortvar = TE,\n  ref = 0,\n  xlim = c(-0.8, 0.8),\n  layout = \"RevMan5\"\n)\n```\n\n::: {.cell-output-display}\n![](4-internal-external-cross-performance_files/figure-jats/unnamed-chunk-3-2.png)\n:::\n\n```{.r .cell-code .hidden}\ncross_calibration_slope_meta <- metagen(\n  data = cross_estimates,\n  studlab = site,\n  TE = cross_calibration_slope,\n  lower = cross_calibration_slope_lower,\n  upper = cross_calibration_slope_upper,\n  sm = \"C_slope\",\n  common = FALSE,\n  random = TRUE,\n  method.tau = \"REML\",\n  method.random.ci = \"HK\",\n  adhoc.hakn.ci = \"IQWiG6\",\n  null.effect = 1\n)\n\nforest_plot_calibration_slope <- forest(\n  cross_calibration_slope_meta,\n  sortvar = TE,\n  ref = 1,\n  xlim = c(0.2, 1.7),\n  layout = \"RevMan5\"\n)\n```\n\n::: {.cell-output-display}\n![](4-internal-external-cross-performance_files/figure-jats/unnamed-chunk-3-3.png)\n:::\n\n```{.r .cell-code .hidden}\ncross_meta_performance <- tibble(\n  site = \"Total\",\n  n = sum(cross_estimates$n),\n  cross_C_index = cross_C_index_meta$TE.random,\n  cross_C_index_lower = cross_C_index_meta$lower.random,\n  cross_C_index_upper = cross_C_index_meta$upper.random,\n  cross_calibration_intercept = cross_calibration_intercept_meta$TE.random,\n  cross_calibration_intercept_lower = cross_calibration_intercept_meta$lower.random,\n  cross_calibration_intercept_upper = cross_calibration_intercept_meta$upper.random,\n  cross_calibration_slope = cross_calibration_slope_meta$TE.random,\n  cross_calibration_slope_lower = cross_calibration_slope_meta$lower.random,\n  cross_calibration_slope_upper = cross_calibration_slope_meta$upper.random\n)\n\ncross_performance_metrics <- bind_rows(cross_estimates, cross_meta_performance)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nsave(cross_performance_metrics, file = \"data/model-performance/cross-performance-metrics.rda\")\n```\n:::\n",
    "supporting": [
      "4-internal-external-cross-performance_files\\figure-jats"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}